<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å•†å“ç®¡ç†å¾Œå°ï¼ˆEmail ç™»å…¥ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    h1 {
      margin: 0 0 4px 0;
      font-size: 22px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 13px;
      margin-bottom: 16px;
    }
    a.link {
      color: #2563eb;
      text-decoration: none;
      font-size: 13px;
    }
    a.link:hover {
      text-decoration: underline;
    }

    .card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 16px;
      margin-top: 16px;
      background: #f9fafb;
    }
    .card-title {
      font-size: 16px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .field {
      flex: 1;
      min-width: 160px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .field input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-danger  { background: #dc2626; color: #fff; }
    .btn-secondary { background: #6b7280; color: #fff; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }
    thead {
      background: #f3f4f6;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    tr:nth-child(even) td {
      background-color: #fafafa;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
      color: #4338ca;
    }
    .qty-ok   { color: #15803d; }
    .qty-low  { color: #ca8a04; }
    .qty-out  { color: #b91c1c; }

    #status {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    /* åˆå§‹å…ˆéš±è—ç®¡ç†å€ï¼Œåªé¡¯ç¤ºç™»å…¥å€ */
    #manage-area {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å•†å“ç®¡ç†å¾Œå°</h1>
    <div class="subtitle">
      ä½¿ç”¨ Email / å¯†ç¢¼ç™»å…¥å¾Œæ‰èƒ½ä¿®æ”¹ Realtime Database çš„ <code>product</code>ã€‚<br />
      <a class="link" href="IOT.html" target="_blank">ğŸ‘‰ å‰å¾€é¡¯ç¤ºé é¢ï¼ˆåº«å­˜çœ‹æ¿ï¼‰</a>
    </div>

    <!-- ğŸ” ç™»å…¥å€ -->
    <div class="card" id="login-area">
      <div class="card-title">ç®¡ç†è€…ç™»å…¥</div>
      <div class="form-row">
        <div class="field">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="ä¾‹å¦‚ï¼šadmin@ntu-iot.com" value="admin@ntu-iot.com" />
        </div>
        <div class="field">
          <label for="login-password">å¯†ç¢¼</label>
          <input type="password" id="login-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
        </div>
      </div>
      <button class="btn btn-primary" id="login-btn">ç™»å…¥</button>
      <span id="login-msg" style="font-size:12px;color:#b91c1c;margin-left:8px;"></span>
    </div>

    <!-- ğŸ›  ç®¡ç†å€ï¼ˆç™»å…¥å¾Œæ‰é¡¯ç¤ºï¼‰ -->
    <div id="manage-area">
      <!-- ç›®å‰ product æ¸…å–® -->
      <div class="card">
        <div class="card-title">ç›®å‰å•†å“åˆ—è¡¨</div>
        <table>
          <thead>
            <tr>
              <th>key</th>
              <th>æ¡Œè™Ÿ table_id</th>
              <th>å•†å“åç¨± name</th>
              <th>æ•¸é‡ number</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="product-tbody">
            <!-- JS ç”¢ç”Ÿ -->
          </tbody>
        </table>
      </div>

      <!-- æ–°å¢ / ä¿®æ”¹ è¡¨å–® -->
      <div class="card">
        <div class="card-title" id="form-title">æ–°å¢å•†å“</div>
        <div class="form-row">
          <div class="field">
            <label for="table_id">æ¡Œè™Ÿ table_id</label>
            <input type="number" id="table_id" placeholder="ä¾‹å¦‚ï¼š1" />
          </div>
          <div class="field">
            <label for="name">å•†å“åç¨± name</label>
            <input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šnoodle" />
          </div>
          <div class="field">
            <label for="number">æ•¸é‡ number</label>
            <input type="number" id="number" placeholder="ä¾‹å¦‚ï¼š10" />
          </div>
        </div>
        <button class="btn btn-primary" id="save-btn">å„²å­˜</button>
        <button class="btn btn-secondary" id="reset-btn">æ¸…ç©º / æ–°å¢æ¨¡å¼</button>
      </div>
    </div>

    <div id="status">å°šæœªç™»å…¥</div>
  </div>

  <!-- Firebase + ç®¡ç†ç¨‹å¼ç¢¼ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    //import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
	import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // ğŸš© ä½ çš„ Firebase è¨­å®šï¼ˆè·Ÿ IOT.html ä¸€æ¨£ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyCcnUT8TN1RuiOBifEqEznRlogNrwX-sI0",
      authDomain: "ntuiot-f7743.firebaseapp.com",
      databaseURL: "https://ntuiot-f7743-default-rtdb.firebaseio.com",
      projectId: "ntuiot-f7743",
      storageBucket: "ntuiot-f7743.firebasestorage.app",
      messagingSenderId: "224195625096",
      appId: "1:224195625096:web:a0bcbefcf733f6b8d35f3d",
      measurementId: "G-VPMLNE6BF5"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    const loginArea   = document.getElementById("login-area");
    const manageArea  = document.getElementById("manage-area");
    const loginEmail  = document.getElementById("login-email");
    const loginPwd    = document.getElementById("login-password");
    const loginBtn    = document.getElementById("login-btn");
    const loginMsg    = document.getElementById("login-msg");

    const tbody      = document.getElementById("product-tbody");
    const statusEl   = document.getElementById("status");
    const formTitle  = document.getElementById("form-title");
    const tableInput = document.getElementById("table_id");
    const nameInput  = document.getElementById("name");
    const numInput   = document.getElementById("number");
    const saveBtn    = document.getElementById("save-btn");
    const resetBtn   = document.getElementById("reset-btn");

    let currentKey = null;  // ç›®å‰æ­£åœ¨ä¿®æ”¹çš„ product key
    let productListenerInited = false;

	const ADMIN_EMAIL = prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¸³è™Ÿï¼š");   // å¦‚æœä½ ç”¨åˆ¥çš„ï¼Œå°±æ”¹é€™è£¡

	// å•ä½ è¦è¼¸å…¥å¯†ç¢¼ï¼ˆæœ€ç°¡å–®åšæ³•ï¼Œä¸ç”¨æ”¹ HTMLï¼‰
	const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼š");

	signInWithEmailAndPassword(auth, ADMIN_EMAIL, pwd)
	  .then(() => {
		console.log("å·²ç”¨ç®¡ç†å¸³è™Ÿç™»å…¥");
		statusEl.textContent = "å·²ç™»å…¥ç®¡ç†å¸³è™Ÿï¼Œæ­£åœ¨è®€å–è³‡æ–™â€¦";
		initProductListener();   // âœ… ç™»å…¥æˆåŠŸæ‰é–‹å§‹è®€/å¯« product
	  })
	  .catch((err) => {
		console.error("ç™»å…¥å¤±æ•—", err);
		statusEl.textContent = "ç™»å…¥å¤±æ•—ï¼š" + err.message;
		alert("ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¯†ç¢¼æ˜¯å¦æ­£ç¢º");
	  });

    // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("å·²ç™»å…¥ï¼ŒUID:", user.uid);
        statusEl.textContent = "å·²ç™»å…¥ï¼š" + user.email + " ï¼ˆUID: " + user.uid + "ï¼‰";

        // é¡¯ç¤ºç®¡ç†å€ã€éš±è—ç™»å…¥å€
        loginArea.style.display  = "none";
        manageArea.style.display = "block";

        // åˆå§‹åŒ–è³‡æ–™ç›£è½ï¼ˆåªåšä¸€æ¬¡ï¼‰
        if (!productListenerInited) {
          initProductListener();
          productListenerInited = true;
        }
      } else {
        console.log("æœªç™»å…¥");
        statusEl.textContent = "å°šæœªç™»å…¥æˆ–å·²ç™»å‡º";
        loginArea.style.display  = "block";
        manageArea.style.display = "none";
      }
    });

    // ğŸ“¡ ç›£è½ product è³‡æ–™
    function initProductListener() {
      const productRef = ref(db, "product");
      onValue(productRef, (snapshot) => {
        const data = snapshot.val() || {};
        renderTable(data);
        statusEl.textContent = "è³‡æ–™å·²æ›´æ–°ï¼š" + new Date().toLocaleString();
      }, (error) => {
        console.error(error);
        statusEl.textContent = "è®€å– product å¤±æ•—ï¼š" + error.message;
      });
    }

    // æ¸²æŸ“å•†å“åˆ—è¡¨
    function renderTable(data) {
      tbody.innerHTML = "";
      Object.entries(data).forEach(([key, item]) => {
        const tr = document.createElement("tr");

        const tableId = item.table_id ?? "-";
        const name    = item.name ?? "(æœªå‘½å)";
        const qtyNum  = Number(item.number ?? 0);

        let qtyClass = "qty-ok";
        if (qtyNum === 0) qtyClass = "qty-out";
        else if (qtyNum <= 5) qtyClass = "qty-low";

        tr.innerHTML = `
          <td style="font-size:11px;color:#6b7280;">${key}</td>
          <td><span class="badge">${tableId}</span></td>
          <td>${name}</td>
          <td class="${qtyClass}">${qtyNum}</td>
          <td>
            <button class="btn btn-primary" data-action="edit" data-key="${key}">ä¿®æ”¹</button>
            <button class="btn btn-danger" data-action="delete" data-key="${key}">åˆªé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // è™•ç†ã€Œä¿®æ”¹ / åˆªé™¤ã€æŒ‰éˆ•
    tbody.addEventListener("click", (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;

      const action = btn.getAttribute("data-action");
      const key    = btn.getAttribute("data-key");
      if (!action || !key) return;

      if (action === "edit") {
        const row = btn.closest("tr");
        const tds = row.querySelectorAll("td");
        tableInput.value = tds[1].innerText.trim();
        nameInput.value  = tds[2].innerText.trim();
        numInput.value   = tds[3].innerText.trim();
        currentKey = key;
        formTitle.textContent = "ä¿®æ”¹å•†å“ï¼ˆkey: " + key + "ï¼‰";
      }

      if (action === "delete") {
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å•†å“å—ï¼Ÿ")) {
          const itemRef = ref(db, "product/" + key);
          remove(itemRef)
            .then(() => {
              statusEl.textContent = "å·²åˆªé™¤å•†å“ key: " + key;
            })
            .catch(err => {
              console.error(err);
              statusEl.textContent = "åˆªé™¤å¤±æ•—ï¼š" + err.message;
            });
        }
      }
    });

    // å„²å­˜ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
    saveBtn.addEventListener("click", () => {
      const tableId = Number(tableInput.value);
      const name    = nameInput.value.trim();
      const qty     = Number(numInput.value);

      if (!name) {
        alert("è«‹è¼¸å…¥å•†å“åç¨±");
        return;
      }

      const payload = {
        table_id: isNaN(tableId) ? null : tableId,
        name: name,
        number: isNaN(qty) ? 0 : qty,
        id: 0   // ä½ åŸæœ¬è³‡æ–™è£¡æœ‰ id:0ï¼Œå¦‚æœ‰å…¶ä»–é‚è¼¯å¯è‡ªè¡Œèª¿æ•´
      };

      if (currentKey) {
        const itemRef = ref(db, "product/" + currentKey);
        update(itemRef, payload)
          .then(() => {
            statusEl.textContent = "å·²æ›´æ–°å•†å“ key: " + currentKey;
            resetForm();
          })
          .catch(err => {
            console.error(err);
            statusEl.textContent = "æ›´æ–°å¤±æ•—ï¼š" + err.message;
          });
      } else {
        const productRef = ref(db, "product");
        push(productRef, payload)
          .then(() => {
            statusEl.textContent = "å·²æ–°å¢å•†å“";
            resetForm();
          })
          .catch(err => {
            console.error(err);
            statusEl.textContent = "æ–°å¢å¤±æ•—ï¼š" + err.message;
          });
      }
    });

    function resetForm() {
      currentKey = null;
      tableInput.value = "";
      nameInput.value  = "";
      numInput.value   = "";
      formTitle.textContent = "æ–°å¢å•†å“";
    }
    resetBtn.addEventListener("click", resetForm);
  </script>
</body>
</html>
